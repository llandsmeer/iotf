# Method

Measured amount of loop bodies executed after 10 seconds.
Of course this was not exactly 10 seconds, so the
Measured time is displayed next to it.
No gap junctions.


```python
a = time.time()
ntimesteps = 0
while True:
    state = model(state)
    b = time.time()
    ntimesteps += 1
    if b - a > 10:
        break
print(ncells, ntimesteps, b - a)
```

Versions:

 - `poplar_sdk-ubuntu_18_04-2.5.1+1001-64add8f33d`
 - `tensorflow-2.5.2+gc2.5.1+193148+4673d3afb3b+intel_skylake512-cp36-cp36m-linux_x86_64.whl`

# Results

default: one IPU, fast math=False, keras model

identical cells
single timestep in python loop

```
ncells   iters seconds
======== ===== ==================
       1   361 10.017030477523804           # 1108x slower than realtime
      10   357 10.006501436233520
     100   339 10.014425516128540
    1000   301 10.028160095214844
   10000   280 10.011113643646240
  100000   131 10.029689550399780
 1000000    74 10.018659591674805
10000000    11 10.145269632339478
```

identical cells
40 timesteps (unrolled) in python loop

```
ncells   iters seconds            timesteps
======== ===== ================== =========
       1     8 10.172812223434448       320 # 1250x slower than realtime
      10     8 10.551693677902222       320
     100     8 10.365052461624146       320
    1000     7 10.353289127349854       280
   10000     6 10.475904226303100       240
  100000     3 10.380901098251343       120
 1000000     2 10.890616178512573        80
10000000     1 40.158017396926880        40
```

no keras model, straight python function
state = ipu.loops.repeat(40, timestep, state)
fastmath = True

```
ncells   iters seconds            timesteps
======== ===== ================== =========
       1    44 10.045462369918823      1760 # 227x slower than realtime
      10    44 10.046343088150024      1760
     100    39 10.078846216201782      1560 
    1000    37 10.124748706817627      1480
   10000    30 10.058508157730103      1200
  100000     6 10.004786252975464       240
 1000000     4 11.817041873931885       160
10000000     1 34.748606681823730        40
```

no keras model, tf.function
state = ipu.loops.repeat(40, timestep, state)
fastmath = True

```
ncells   iters seconds            timesteps
======== ===== ================== =========
       1   681 10.012451648712158     27240 # 14x slower than realtime
      10   659 10.012555360794067     26360
     100   618 10.013664960861206     24720
    1000   481 10.016881704330444     19240
   10000   105 10.047434329986572      4200
  100000    27 10.134548187255860      1080
 1000000     5 10.176772832870483       200
10000000     1 11.787176370620728        40
```

randomized g_CaL
single timestep in python loop

```
ncells   iters seconds
======== ===== ==================
       1   356 10.010644435882568
      10   352 10.023517608642578
     100   333 10.015699386596680
    1000   298 10.030692100524902
   10000   275 10.033795356750488
  100000   129 10.006984949111938
 1000000    74 10.000863313674927
10000000    11 10.461909532546997
```

16 IPU pairwise (select=16)
identical cells
single timestep in python loop

```
ncells   iters seconds
======== ===== ==================
       1   352 10.015149116516113
      10   354 10.024873256683350
     100   335 10.000465869903564
    1000   296 10.013682603836060
   10000   277 10.026544332504272
  100000   131 10.023094177246094
 1000000    75 10.028786420822144
10000000    11 10.489652633666992
```

one IPU
identical cells
fast math = true

```
ncells   iters seconds
======== ===== ==================
       1   352 10.001994371414185
      10   349 10.009512424468994
     100   330 10.014633417129517
    1000   296 10.019960165023804
   10000   274 10.006435632705688
  100000   130 10.018420934677124
 1000000    74 10.078833103179932
10000000    11 10.501261472702026
```

## Round 2: Gap junctions

tf.function
single timestep,
jit burn in
linear nearest neighbour gap junctions


```
ngapps ncells    iters  seconds  slowdown
====== ========= ====== ======== ========
     0         0   3437    1.000   11.64x
     0         1   3305    1.000   12.10x
     0        10   3289    1.000   12.16x
     2        10   3256    1.000   12.29x
     4        10   3303    1.000   12.11x
     6        10   3333    1.000   12.00x
     0       100   3047    1.000   13.13x
     2       100   3032    1.000   13.19x
     4       100   3021    1.000   13.24x
    10       100   3031    1.000   13.20x
    50       100   2985    1.000   13.40x
     0      1000   2266    1.000   17.65x
     2      1000   2271    1.000   17.62x
     4      1000   2277    1.000   17.57x
   100      1000   2190    1.000   18.27x
   500      1000   1271    1.000   31.48x
     0     10000    473    1.000   84.59x
     2     10000    447    1.002   89.64x
     4     10000    442    1.001   90.62x
  1000     10000     82    1.007  491.37x
  5000     10000     22    1.002 1820.92x
     0    100000    116    1.004  346.18x
     2    100000    113    1.002  354.82x
     4    100000    114    1.002  351.56x
 10000    100000      2    1.560 31209.56x
Segmentation fault (core dumped)
```

cx36

```
ngapps ncells    iters  seconds  slowdown
====== ========= ====== ======== ========
     0         0   3521    1.000   11.36x
     0         1   3380    1.000   11.84x
     0        10   3354    1.000   11.93x
     2        10   3220    1.000   12.42x
     0       100   3004    1.000   13.32x
     2       100   3000    1.000   13.34x
    10       100   2979    1.000   13.43x
     0      1000   2272    1.000   17.61x
     2      1000   2265    1.000   17.66x
    10      1000   2254    1.000   17.75x
   100      1000   1376    1.000   29.08x
     0     10000    469    1.002   85.45x
     2     10000    436    1.001   91.84x
    10     10000    354    1.000  113.01x
   100     10000     94    1.008  428.90x
  1000     10000     25    1.014 1622.21x
     0    100000    112    1.006  359.36x
     2    100000    108    1.004  371.96x
    10    100000     82    1.006  490.62x
   100    100000     19    1.050 2210.85x
  1000    100000      3    1.240 16535.50x
 10000    100000      1    7.218 288727.27x
     0   1000000     31    1.012 1306.10x
     2   1000000     31    1.029 1328.14x
    10   1000000     22    1.019 1852.23x
   100   1000000      3    1.227 16359.57x
  1000   1000000      1    2.736 109429.86x
```
